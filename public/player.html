<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="player.css">
</head>
<body>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <div class="logo">üé±</div>
            <h1>BINGO GAME</h1>
            <div class="input-group">
                <input type="text" id="playerName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" maxlength="15">
            </div>
            <button id="joinBtn" class="btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen hidden">
        <div class="header">
            <div class="player-info">
                <span class="avatar">üë§</span>
                <span id="displayPlayerName">Player</span>
            </div>
            <div class="latest-number" id="latestNumber">--</div>
        </div>

        <div class="bingo-board-container">
            <div class="bingo-header">
                <div>B</div><div>I</div><div>N</div><div>G</div><div>O</div>
            </div>
            <div class="bingo-grid" id="bingoGrid">
                <!-- Generated by JS -->
            </div>
        </div>

        <div class="controls">
            <button id="claimBingoBtn" class="btn-bingo" disabled>üéâ BINGO! üéâ</button>
        </div>
    </div>

    <!-- Winner Overlay -->
    <div id="winnerOverlay" class="overlay">
        <div class="overlay-content">
            <div class="trophy">üèÜ</div>
            <h2 id="winnerText">‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß!</h2>
            <button id="closeOverlayBtn" class="btn-secondary">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script>
        // State
        let socket = null;
        let myCard = [];
        let myMarks = new Set();
        let calledNumbers = new Set();
        let playerId = null;

        // Elements
        const loginScreen = document.getElementById('loginScreen');
        const gameScreen = document.getElementById('gameScreen');
        const playerNameInput = document.getElementById('playerName');
        const joinBtn = document.getElementById('joinBtn');
        const bingoGrid = document.getElementById('bingoGrid');
        const displayPlayerName = document.getElementById('displayPlayerName');
        const latestNumberDisplay = document.getElementById('latestNumber');
        const claimBingoBtn = document.getElementById('claimBingoBtn');
        const winnerOverlay = document.getElementById('winnerOverlay');
        const winnerText = document.getElementById('winnerText');
        const closeOverlayBtn = document.getElementById('closeOverlayBtn');

        // Connect
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            socket = new WebSocket(`${protocol}//${host}`);

            socket.onopen = () => {
                console.log('Connected to server');
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            socket.onclose = () => {
                alert('Connection lost. Please refresh.');
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'game_joined':
                    playerId = data.payload.id;
                    myCard = data.payload.card;
                    calledNumbers = new Set(data.payload.calledNumbers);
                    
                    renderCard();
                    updateDisplayFromHistory();
                    
                    loginScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                    break;

                case 'number_called':
                    const num = data.payload.number;
                    calledNumbers.add(num);
                    animateLatestNumber(num);
                    highlightCalledNumber(num);
                    checkPossibleBingo();
                    break;

                case 'game_reset_new_card':
                    myCard = data.payload.card;
                    myMarks.clear();
                    calledNumbers.clear();
                    renderCard();
                    latestNumberDisplay.textContent = '--';
                    winnerOverlay.classList.remove('show');
                    break;

                case 'player_won':
                    winnerText.textContent = `${data.payload.name} BINGO!`;
                    winnerOverlay.classList.add('show');
                    // Play win sound if we want
                    break;
            }
        }

        function renderCard() {
            bingoGrid.innerHTML = '';
            // card is [col1, col2, col3...]
            // We need to render row by row
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const value = myCard[c][r];
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    if (value === 'FREE') {
                        cell.classList.add('free', 'marked');
                        cell.textContent = '‚òÖ';
                        // Auto mark free space logic handled in check
                    } else {
                        cell.textContent = value;
                        cell.dataset.num = value;
                        cell.addEventListener('click', () => toggleMark(cell, value));
                        
                        // Restore state if re-rendering (not fully implemented reuse, but good practice)
                        if (myMarks.has(value)) {
                            cell.classList.add('marked');
                        }
                    }
                    bingoGrid.appendChild(cell);
                }
            }
        }

        function toggleMark(cell, num) {
            if (!calledNumbers.has(num)) {
                // Optional: Shake animation for "not called yet"
                cell.classList.add('error');
                setTimeout(() => cell.classList.remove('error'), 500);
                return;
            }

            if (myMarks.has(num)) {
                myMarks.delete(num);
                cell.classList.remove('marked');
            } else {
                myMarks.add(num);
                cell.classList.add('marked');
            }

            checkPossibleBingo();
        }

        function highlightCalledNumber(num) {
            // Find cell and maybe add a "suggestion" glow?
            // For now, we rely on user manually looking.
        }

        function updateDisplayFromHistory() {
            if (calledNumbers.size > 0) {
                const last = Array.from(calledNumbers).pop();
                latestNumberDisplay.textContent = last;
            }
        }

        function animateLatestNumber(num) {
            latestNumberDisplay.classList.add('pop');
            latestNumberDisplay.textContent = num;
            setTimeout(() => latestNumberDisplay.classList.remove('pop'), 300);
        }

        function checkPossibleBingo() {
            // Client-side validation to enable button
            // FREE space is effectively marked for logic
            const isMarked = (r, c) => {
                if (r === 2 && c === 2) return true;
                const num = myCard[c][r];
                return myMarks.has(num);
            };

            let bingo = false;
            // Cols
            for (let c = 0; c < 5; c++) if ([0,1,2,3,4].every(r => isMarked(r,c))) bingo = true;
            // Rows
            for (let r = 0; r < 5; r++) if ([0,1,2,3,4].every(c => isMarked(r,c))) bingo = true;
            // Diagonals
            if ([0,1,2,3,4].every(i => isMarked(i,i))) bingo = true;
            if ([0,1,2,3,4].every(i => isMarked(i,4-i))) bingo = true;

            claimBingoBtn.disabled = !bingo;
            if (bingo) {
                claimBingoBtn.classList.add('pulse');
            } else {
                claimBingoBtn.classList.remove('pulse');
            }
        }

        // Event Listeners
        joinBtn.addEventListener('click', () => {
            const name = playerNameInput.value.trim();
            if (name) {
                displayPlayerName.textContent = name;
                socket.send(JSON.stringify({
                    type: 'player_join',
                    payload: { name }
                }));
            }
        });

        claimBingoBtn.addEventListener('click', () => {
            socket.send(JSON.stringify({
                type: 'player_claim_bingo',
                payload: { marks: Array.from(myMarks) }
            }));
        });

        closeOverlayBtn.addEventListener('click', () => {
            winnerOverlay.classList.remove('show');
        });

        // Initialize
        connect();

    </script>
</body>
</html>
